<!DOCTYPE html>
<html lang="it">
  <head>
    <% include partials/head.ejs %>
  </head>
  <body style="padding-top: 72px;">
    <% include partials/header.ejs %>
    <div class="container-fluid">               
      <div class="row">
        <div class="col-lg-7 col-xl-5 px-4 pb-4 pl-xl-5 pr-xl-5">
          <section class="mx-n4 mx-xl-n5 mb-4 mb-xl-5">
            <!-- Slider main container-->
            <div class="swiper-container booking-detail-slider">
              <!-- Additional required wrapper-->
              <div class="swiper-wrapper">
                <!-- Slides-->
                <% if (data.data_pren.foto_0 != null && data.data_pren.foto_0 != undefined) { %>
                  <div class="swiper-slide"><img class="img-fluid" src="../images/<%= data.data_pren.foto_0 %>"></div>
                <% } %>
                <% if (data.data_pren.foto_1 != null && data.data_pren.foto_1 != undefined) { %>
                  <div class="swiper-slide"><img class="img-fluid" src="../images/<%= data.data_pren.foto_1 %>"></div>
                <% } %>
                <% if (data.data_pren.foto_2 != null && data.data_pren.foto_2 != undefined) { %>
                  <div class="swiper-slide"><img class="img-fluid" src="../images/<%= data.data_pren.foto_2 %>"></div>
                <% } %>
                <% if (data.data_pren.foto_3 != null && data.data_pren.foto_3 != undefined) { %>
                  <div class="swiper-slide"><img class="img-fluid" src="../images/<%= data.data_pren.foto_3 %>"></div>
                <% } %>
                <% if (data.data_pren.foto_4 != null && data.data_pren.foto_4 != undefined) { %>
                  <div class="swiper-slide"><img class="img-fluid" src="../images/<%= data.data_pren.foto_4 %>"></div>
                <% } %>
                <% if (data.data_pren.foto_5 != null && data.data_pren.foto_5 != undefined) { %>
                  <div class="swiper-slide"><img class="img-fluid" src="../images/<%= data.data_pren.foto_5 %>"></div>
                <% } %>
              </div>
              <div class="swiper-pagination swiper-pagination-white"></div>
              <div class="swiper-button-prev swiper-button-white"></div>
              <div class="swiper-button-next swiper-button-white">   </div>
            </div>
          </section>
          <!-- Breadcrumbs -->
          <ol class="breadcrumb pl-0  justify-content-start">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item"><a href="/profiloHostControl/finestraListaPrenotazioniRicevute">I tuoi ospiti</a></li>
            <li class="breadcrumb-item active">Prenotazione ricevuta   </li>
          </ol>
          <div class="text-block">
            <p class="subtitle"><%= data.data_pren.data_inizio %> - <%= data.data_pren.data_fine %></p>
            <h1 class="hero-heading mb-3"><%= data.data_pren.titolo %></h1>
          </div>
          <div class="text-block">
            <h6 class="mb-4"><%= data.data_pren.data_fine.toString().split(' ')[0] - data.data_pren.data_inizio.toString().split(' ')[0] %> notti</h6>
            <div class="row mb-3">
              <div class="col-md-6 d-flex align-items-center mb-3 mb-md-0">
                <div class="date-tile mr-3">
                  <div class="text-uppercase"> <span class="text-sm"><%= data.data_pren.data_inizio.toString().split(' ')[1] %></span><br><strong class="text-lg"><%= data.data_pren.data_inizio.toString().slice(0,2) %></strong></div>
                </div>
                <p class="text-sm mb-0">check-in</p>
              </div>
              <div class="col-md-6 d-flex align-items-center">
                <div class="date-tile mr-3">
                  <div class="text-uppercase"> <span class="text-sm"><%= data.data_pren.data_fine.toString().split(' ')[1] %></span><br><strong class="text-lg"><%= data.data_pren.data_fine.toString().slice(0,2) %></strong></div>
                </div>
                <p class="text-sm mb-0">check-out</p>
              </div>
            </div>
          </div>
          <div class="text-block">
            <div class="row">
              <div class="col-sm">
                <h6>Indirizzo</h6>
                <p class="text-muted"><%= data.data_pren.indirizzo %> <%= data.data_pren.n_civico %>, <%= data.data_pren.citta %></p>
              </div>
              <div class="col-sm">
                <h6>Telefono</h6>
                <p class="text-muted"><%= data.data_pren.telefono_ut %></p>
              </div>
            </div>
          </div>
          <div class="text-block">
            <div class="media align-items-center mb-3">
              <div class="media-body">
                <h6><%= data.data_pren.tipo_all %></h6>
                <p class="text-muted mb-0"><a href="user-profile.html" class="text-reset"><%= data.data_pren.nome_ut %> <%= data.data_pren.cognome_ut %></a> ha prenotato.</p>
              </div><a href="user-profile.html"><img class="avatar avatar-lg avatar-border-white ml-4" src="../images/ominoUtente.png"></a>
            </div>
          </div>
          <div class="text-block">
            <h6 class="mb-3">Altri ospiti</h6>
            <div class="row mb-3">
              <% let ospiti = data.data_pren.nomi_ospiti; if (ospiti == "") { %>
                <p class="text-muted mb-0 pl-3">Nessun altro ospite verrà con te</p>
                <% } else { ospiti = data.data_pren.nomi_ospiti.slice(0, (ospiti.length-1)); ospiti = ospiti.split('-'); for (osp of ospiti) { %>
                <div class="col-auto text-center text-sm"><img class="avatar avatar-border-white mb-1" src="../images/ominoUtente.png"><br><%= osp %></div>
                <% }}; %>
            </div>
          </div>
          <div class="text-block">
            <div class="row">
              <div class="col">
                <h6>Costo totale </h6>
                <p class="text-muted">€<%= data.data_pren.prezzo_totale %></p>
              </div>
            </div>
          </div>

          <div class="text-block">
            <h6 class="mb-4">Azioni </h6>
            <ul class="list-unstyled">

              <li class="mb-2"> 
                <div class="media align-items-center mb-3">
                  <div class="media-body"><a role="button" class="btn btn-outline-info" href="mailto:<%= data.data_pren.email_ut %>">Contatta cliente</a></div>
                </div>
              </li>

              <li class="mb-2"> 
                <div class="media align-items-center mb-3">
                  <div class="py-0">
                    <button class="btn btn-outline-primary" type="button" data-toggle="collapse" data-target="#recensisciCliente" aria-expanded="false" aria-controls="recensisciCliente" <%= data.data_rec %>>Recensisci Cliente</button>
                    <div class="collapse mt-4" id="recensisciCliente">
                      <h5 class="mb-4">Calcolo tasse di soggiorno</h5>
                      <form class="form" id="form_recensione" method="POST" action="/profiloHostControl/recensisciCliente">
                        <div class="row">
                          <div class="col-sm-6">
                            <div class="form-group">
                              <label class="form-label" for="nome"></label>
                              <input class="form-control-plaintext" type="text" placeholder="Fai la tua recensione" readonly>
                            </div>
                          </div>
                          <div class="col-sm-6">
                            <div class="form-group">
                              <label class="form-label" for="valutazione">La tua valutazione</label>
                              <select class="custom-select focus-shadow-0" name="valutazione" id="valutazione">
                                <option value="5">&#9733;&#9733;&#9733;&#9733;&#9733; 5</option>
                                <option value="4">&#9733;&#9733;&#9733;&#9733;&#9734; 4</option>
                                <option value="3">&#9733;&#9733;&#9733;&#9734;&#9734; 3</option>
                                <option value="2">&#9733;&#9733;&#9734;&#9734;&#9734; 2</option>
                                <option value="1">&#9733;&#9734;&#9734;&#9734;&#9734; 1</option>
                              </select>
                            </div>
                          </div>
                        </div>
                        <div class="form-group">
                          <label class="form-label" for="testoRec">Testo </label>
                          <textarea class="form-control" rows="4" name="testoRec" id="testoRec" placeholder="Scrivi qualcosa sul cliente" required="required"></textarea>
                        </div>
                        <button class="btn btn-primary" id="inviaRecensione" type="submit">Invia</button>
                      </form>
                    </div>
                  </div>
                </div>
              </li>

              <li class="mb-2"> 
                <div class="media align-items-center mb-3">
                  <div class="py-0">
                    <button class="btn btn-outline-secondary" id="calcolatasse" type="button" data-toggle="collapse" data-target="#calcolaTasse" aria-expanded="false" aria-controls="calcolaTasse">Calcola tasse</button>
                   
                    <div class="collapse mt-4" id="calcolaTasse">
                      <h5 class="mb-4">Tasse di soggiorno</h5>
                      
                        <table class="table col-sm-6">
                          <thead>
                            <tr>
                              <th scope="col">Ospite</th>
                              <th scope="col">Nome</th>
                              <th scope="col">Nazionalità</th>
                              <th scope="col">Età</th>
                              <th scope="col">Paga</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr>
                              <th scope="row">1</th>
                              <td><%= data.data_pren.nome_ut %> <%= data.data_pren.cognome_ut %></td>
                              <td><%= data.data_pren.naz_prenotante %></td>
                              <td><%= data.data_pren.eta_prenotante %></td>
                              <% var totaleTasse = 0.0; if (data.data_pren.naz_prenotante != 'Italia') { totaleTasse += data.data_pren.tasse_alloggio; %>
                                <td>&euro; <%= data.data_pren.tasse_alloggio %></td>
                              <% } else { %>
                                <td>&euro; 0.00</td>
                              <% } %>
                            </tr>
                            <% if (ospiti == "") { %>
                              <!-- Non ci sono ospiti oltre al prenotante, quindi non ci sono ulteriori righe della tabella-->
                            <% } else { %>
                              <% let nomi_ospiti = data.data_pren.nomi_ospiti.slice(0, (data.data_pren.nomi_ospiti.length-1)); nomi_ospiti = nomi_ospiti.split('-'); %>
                              <% let naz_ospiti = data.data_pren.naz_ospiti.slice(0, (data.data_pren.naz_ospiti.length-1)); naz_ospiti = naz_ospiti.split('-'); %>
                              <% let eta_ospiti = data.data_pren.eta_osp.slice(0, (data.data_pren.eta_osp.length-1)); eta_ospiti = eta_ospiti.split('-'); %>
                              <!-- Stampa una riga della tabella per ogni ospite-->
                              <% for (let i = 0; i < ospiti.length; i++) { %>  
                                <tr>
                                  <th scope="row"><%= i+2 %></th>
                                  <td><%= nomi_ospiti[i] %></td>
                                  <td><%= naz_ospiti[i] %></td>
                                  <td><%= eta_ospiti[i] %></td>
                                  <% if (naz_ospiti[i] != 'It' || eta_ospiti[i] > 6) { totaleTasse += data.data_pren.tasse_alloggio; %>
                                    <td>&euro; <%= data.data_pren.tasse_alloggio  %></td>
                                  <% } else { %>
                                    <td>&euro; 0</td>
                                  <% } %>
                                </tr>
                              <% } %>
                            <% }; %> 
                        
                                <tr>
                                  <th scope="row">Totale giornaliero</th>
                                  <td></td>
                                  <td></td>
                                  <td></td>
                                  <td name="tassepagate" id="tassepagate">&euro; <span><%= totaleTasse %></span></td>
                                </tr>

                          </tbody>
                        </table>
                        <button class="btn btn-primary" id="confermaPagamentoTasse">Conferma pagamento</button>
                    </div>
                  </div>
                </div>
              </li>

              <li class="mb-2"> 
                <div class="media align-items-center mb-3">
                  <div class="py-0">
                    <button class="btn btn-outline-dark" id="inviaDocumenti" type="button" data-toggle="collapse" data-target="#inviadocumenti" aria-expanded="false" aria-controls="inviadocumenti">Comunica documenti</button>
                   
                    <div class="collapse mt-4" id="inviadocumenti">
                      <h5 class="mb-4">Documenti ospiti</h5>
                      
                        <table class="table col-sm-6">
                          <thead>
                            <tr>
                              <th scope="col">Nome</th>
                              <th scope="col">Tipo documento</th>
                              <th scope="col">Numero documento</th>
                              <th scope="col">Data di scadenza</th>
                              <th scope="col">File</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr>
                              <td><%= data.data_pren.nome_ut %> <%= data.data_pren.cognome_ut %></td>
                              <td><%= data.data_pren.tipo_doc_ur %></td>
                              <td><%= data.data_pren.num_doc_ur %></td>
                              <td><%= data.data_pren.scadenza_doc_ur %></td>
                            </tr>
                            <% if (ospiti == "") { %>
                              <!-- Non ci sono ospiti oltre al prenotante, quindi non ci sono ulteriori righe della tabella-->
                            <% } else { %>
                              <% let nomi_ospiti = data.data_pren.nomi_ospiti.slice(0, (data.data_pren.nomi_ospiti.length-1)); nomi_ospiti = nomi_ospiti.split('-'); %>
                              <% let naz_ospiti = data.data_pren.naz_ospiti.slice(0, (data.data_pren.naz_ospiti.length-1)); naz_ospiti = naz_ospiti.split('-'); %>
                              <% let eta_ospiti = data.data_pren.eta_osp.slice(0, (data.data_pren.eta_osp.length-1)); eta_ospiti = eta_ospiti.split('-'); %>
                              <!-- Stampa una riga della tabella per ogni ospite-->
                              <% for (let i = 0; i < ospiti.length; i++) { %>  
                                <tr>
                                  <td><%= nomi_ospiti[i] %></td>
                                  <td><%= naz_ospiti[i] %></td>
                                  <td><%= eta_ospiti[i] %></td>
                                  <% if (naz_ospiti[i] != 'It' || eta_ospiti[i] > 6) { totaleTasse += data.data_pren.tasse_alloggio; %>
                                    <td>&euro; <%= data.data_pren.tasse_alloggio  %></td>
                                  <% } else { %>
                                    <td>&euro; 0</td>
                                  <% } %>
                                </tr>
                              <% } %>
                            <% }; %> 
                        
                                

                          </tbody>
                        </table>
                        <button class="btn btn-primary" id="confermaInvioDocumenti">Conferma invio</button>
                    </div>
                  </div>
                </div>
              </li>

              <li class="mb-2"> 
                <div class="media align-items-center mb-3">
                  <div class="py-0">
                    <button class="btn btn-outline-warning" type="button" data-toggle="collapse" data-target="#gestisciPrenotazione" aria-expanded="false" aria-controls="gestisciPrenotazione" <%= data.data_conf %>>Gestisci prenotazione</button>
                    <div class="collapse mt-4" id="gestisciPrenotazione">
                      <h5 class="mb-4">Accetta o declina la prenotazione </h5>
                      <div class="row">
                        <div class="col-sm-6 mb-2">
                          <a href="/profiloHostControl/accettaPrenotazione" id="accettaPrenotazione"><button class="col btn btn-success">Accetta</button></a>
                        </div>
                        <div class="col-sm-6 mb-2">
                          <a href="/profiloHostControl/declinaPrenotazione" id="declinaPrenotazione"><button class="col btn btn-danger">Declina</button></a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </li>

              
              <li class="mb-2"> 
                <div class="media align-items-center mb-3">
                  <div class="py-0">
                    <button class="btn btn-outline-danger" type="button" data-toggle="collapse" data-target="#annullaPrenotazione" aria-expanded="false" aria-controls="annullaPrenotazione" <%= data.data_ann %>>Annulla prenotazione</button>
                    <div class="collapse mt-4" id="annullaPrenotazione">
                      <h5 class="mb-4">Sei sicuro di voler annullare la prenotazione? </h5>
                      <div class="row">
                        <div class="col-sm-6 mb-2">
                          <a href="/profiloHostControl/annullaPrenotazione" id="confermaAnnullamento"><button class="col btn btn-success">SI</button></a>
                        </div>
                        <div class="col-sm-6 mb-2">
                          <button class="col btn btn-danger" type="button" data-toggle="collapse" data-target="#annullaPrenotazione" aria-expanded="false" aria-controls="annullaPrenotazione">NO</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </li>

            </ul>
          </div>
          <div class="text-block d-print-none"> <!-- PENSARE PER LA RICEVUTA -->
            <button class="btn btn-link pl-0" onclick="window.print()"><i class="fa fa-print mr-2"></i>Print </button>
          </div>
        </div>
        <div class="col-lg-5 col-xl-7 map-side-lg px-lg-0">
          <div class="map-full shadow-left" id="detailSideMap"></div>
        </div>
      </div>
    </div>
    <!-- Footer-->
    <% include partials/footer.ejs %>
    
    <!-- scriptFooter -->
    <% include partials/scriptFooter.ejs %>

    <script>

      $(document).ready(function() {

        $('#confermaAnnullamento').on('click', function() {
          window.alert('Operazione andata a buon fine');
        });

        $('#inviaRecensione').on('click', function() {
          window.alert('Operazione andata a buon fine');
        });

        $('#accettaPrenotazione').on('click', function() {
          window.alert('Operazione andata a buon fine');
        });

        $('#declinaPrenotazione').on('click', function() {
          window.alert('Operazione andata a buon fine');
        });

        // Aggiornamento stato tasse -----------------------------------------------------------------------
        $('#confermaPagamentoTasse').click(function(ev) {
          $.ajax({
            context: this,
            url: '/profiloHostControl/inviatasse',
            type: 'POST',
            data: { tasse : parseFloat($('#tassepagate').children('span').text())},
            success: response => {
              console.log('Response from server is ' + response);
              window.alert('Pagamento tasse aggiornato!')
            }
          });
        });

        let caratteriSpeciali = /([~,@,#,$,^,&,*,-,_,+,=,>,<,',",`])/;

        $('#testoRec').on('input', function(ev) {

          if($('#testoRec').val().match(caratteriSpeciali)) {
              $('#checkTestoRec').text('Carattere speciale non consentito!')
              $('#inviaRecensione').attr('disabled','disabled');
          }
          else {
            $('#checkTestoRec').text('')
            $('#inviaRecensione').removeAttr('disabled','disabled');
          }
        });
      });
    </script>

  </body>
</html>